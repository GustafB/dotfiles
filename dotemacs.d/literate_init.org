#+TITLE:Emacs Config
; -*- lexical-binding: t; -*-
#+BEGIN_SRC emacs-lisp
  (when (not (string= system-type "darwin"))
    (add-to-list 'exec-path "/home/cafebabe/.local/bin"))

  ;; The default is 800 kilobytes.  Measured in bytes.
  (setq gc-cons-threshold (* 50 1000 1000))

  ;; Profile emacs startup
  (add-hook 'emacs-startup-hook
            (lambda ()
              (message "*** Emacs loaded in %s seconds with %d garbage collections."
                       (emacs-init-time "%.2f")
                       gcs-done)))
#+end_src
* Load better default settings
This is a straight clone of [[https://github.com/hrs/sensible-defaults.el][HRS]] defaults setup
#+BEGIN_SRC emacs-lisp
  (load-file "~/.emacs.d/sensible-defaults.el")
  (sensible-defaults/use-all-settings)
  (sensible-defaults/use-all-keybindings)
  (sensible-defaults/backup-to-temp-directory)
  (setq image-types '(svg png gif tiff jpeg xpm xbm pbm))
  (winner-mode 1)
  ;; don't display native compilation warnings
  (setq native-comp-async-report-warnings-errors nil)

  ;; open links in windows default browser
  (when (getenv "WSLENV")
    (let ((cmd-exe "/mnt/c/Windows/System32/cmd.exe")
    (cmd-args '("/c" "start")))
      (when (file-exists-p cmd-exe)
        (setq browse-url-generic-program  cmd-exe
        browse-url-generic-args     cmd-args
        browse-url-browser-function 'browse-url-generic
        search-web-default-browser 'browse-url-generic))))
#+END_SRC
* Configure =use-package=
Add MELPA to package-list
#+BEGIN_SRC emacs-lisp
  (require 'package)
  (add-to-list 'package-archives
               '("melpa" . "http://melpa.org/packages/") t)
  ;; (add-to-list 'package-archives
  ;;              '("org" . "https://orgmode.org/elpa") t)

  (use-package auto-package-update
    :custom
    (auto-package-update-interval 7)
    (auto-package-update-prompt-before-update t)
    (auto-package-update-hide-results t)
    :config
    (auto-package-update-maybe)
    (auto-package-update-at-time "09:00"))
#+END_SRC
Make sure use-package is installed
#+BEGIN_SRC emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))
  (require 'use-package)
  (setq use-package-always-ensure t)

  (column-number-mode)
  (global-display-line-numbers-mode t)
#+END_SRC
* UI Tweaks
** Ivy/counsel/visual
#+BEGIN_SRC emacs-lisp
  (use-package helm
    ;; :init
    ;; :bind (;("M-x" . helm-M-x)
    ;;        ("M-y" . helm-show-kill-ring)
    ;;        ("C-x b" . helm-mini)
    ;;        ("M-/" . helm-dabbrev))
    :hook (prog-mode . helm-mode)
    :config
    (setq
     helm-scroll-amount 4 ; scroll 4 lines other window using M-<next>/M-<prior>
     helm-quick-update t ; do not display invisible candidates
     helm-idle-delay 0.01 ; be idle for this many seconds, before updating in delayed sources.
     helm-input-idle-delay 0.01 ; be idle for this many seconds, before updating candidate buffer
     helm-split-window-default-side 'other ;; open helm buffer in another window
     helm-split-window-in-side-p t ;; open helm buffer inside current window, not occupy whole other window
     helm-candidate-number-limit 200 ; limit the number of displayed canidates
     helm-move-to-line-cycle-in-source nil ; move to end or beginning of source when reaching top or bottom of source.
     ;; helm-command
     helm-M-x-requires-pattern 0     ; show all candidates when set to 0
     helm-M-x-fuzzy-match t
     helm-buffers-fuzzy-matching t
     helm-recentf-fuzzy-match t)
    (bind-keys ("M-x" . helm-M-x)
               ("M-y" . helm-show-kill-ring)
               ("C-x b" . helm-mini))
    (bind-keys :map helm-map
               ("C-o" . nil)
               ("TAB" . helm-execute-persistent-action)
               ("C-i" . helm-execute-persistent-action)
               ("C-z" . helm-select-action)
               ("C-h" . delete-backward-char)))

  (use-package helm-projectile :ensure t :defer t
    :config
    (helm-projectile-on)
    :bind
    ("C-x C-t" . helm-projectile-switch-project)
    ("C-x C-r" . helm-projectile-find-file)
    ("C-x C-f" . helm-find-files))

  (use-package helm-top-elscreen :disabled
    :config
    (bind-keys :map helm-command-map
               ("t" . nil)
               ("t" . helm-elscreen)))

  (use-package helm-ag
    :defer t
    :bind
    ("C-x C-g" . helm-do-ag-project-root))

  (use-package helm-swoop
    :bind
    (("C-s" . helm-swoop-without-pre-input)
     ("C-S-S" . helm-swoop)
     ("M-O" . helm-swoop-back-to-last-point)
     ("C-c C-o" . helm-multi-swoop))
    :config
    ;; Save buffer when helm-multi-swoop-edit complete
    (setq helm-multi-swoop-edit-save t)
    ;; If this value is t, split window inside the current window
    (setq helm-swoop-split-with-multiple-windows nil)
    ;; Split direcion. 'split-window-vertically or 'split-window-horizontally
    (setq helm-swoop-split-direction 'split-window-horizontally)
    ;; If nil, you can slightly boost invoke speed in exchange for text color
    (setq helm-swoop-speed-or-color t)
    (bind-keys :map isearch-mode-map
               ("M-o" . helm-swoop-from-isearch))
    (bind-keys :map helm-swoop-map
               ("C-p" . helm-previous-line)
               ("C-n" . helm-next-line)
               ("M-o" . helm-multi-swoop-all-from-helm-swoop)))

  (use-package diminish)

  (use-package doom-modeline
    :ensure t
    :init
    (doom-modeline-mode 1)
    :config
    (setq doom-modeline-height 10)
    (setq doom-modeline-bar-width 6)
    (setq doom-modeline-lsp t)
    (setq doom-modeline-github t)
    (setq doom-modeline-irc t)
    (setq doom-modeline-minor-modes nil)
    (setq doom-modeline-persp-name nil)
    (setq doom-modeline-evil-state-icon nil)
    (setq doom-modeline-unicode-fallback nil)
    (setq doom-modeline-buffer-file-name-style 'truncate-except-project)
    (setq doom-modeline-major-mode-icon nil)
    :custom ((doom-modeline-height 1))
    :custom-face
    (mode-line ((t (:height 0.95))))
    (mode-line-inactive ((t (:height 0.95)))))

  (use-package doom-themes
    :ensure t
    :init
    (load-theme 'doom-palenight t)
    (doom-themes-visual-bell-config))

  (use-package all-the-icons
    :if (display-graphic-p))

  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))

  (set-face-attribute 'show-paren-match-expression nil :background "#363e4a")
  (show-paren-mode 1)

  (use-package which-key
    :init (which-key-mode)
    :diminish which-key-mode
    :config
    (setq which-key-idle-delay 1))

  (use-package helpful
    ;; :custom
    ;; (counsel-describe-function-function #'helpful-callable)
    ;; (counsel-describe-variable-function #'helpful-variable)
    :bind
    ([remap describe-function] . describe-function)
    ([remap describe-command] . helpful-command)
    ([remap describe-variable] . describe-variable)
    ([remap describe-key] . helpful-key))

  (use-package drag-stuff
    :ensure t
    :config
    (drag-stuff-global-mode 1)
    (drag-stuff-define-keys))
#+END_SRC
** Window Management
#+begin_src emacs-lisp
  (defun gb/generate-scratch-buffer ()
    "Create and switch to a temporary scratch buffer with a random
         name."
    (interactive)
    (switch-to-buffer (make-temp-name "scratch-")))
  (define-key global-map (kbd "C-c g") 'generate-scratch-buffer)

  (defun gb/kill-current-buffer ()
    "Kill the current buffer without prompting."
    (interactive)
    (kill-buffer (current-buffer)))

  (defun gb/split-window-below-and-switch ()
    "Split the window horizontally, then switch to the new pane."
    (interactive)
    (split-window-below)
    (balance-windows)
    (gb/toggle-normal)
    (other-window 1))

  (defun gb/split-window-right-and-switch ()
    "Split the window vertically, then switch to the new pane."
    (interactive)
    (split-window-right)
    (balance-windows)
    (gb/toggle-normal)
    (other-window 1))

  (defun gb/toggle-normal (&optional arg)
    (evil-normal-state))

  (defun gb/other-window ()
    (interactive)
    (ace-select-window)
    (gb/toggle-normal))

  (defun gb/prev-window ()
    (interactive)
    (other-window -1)
    (gb/toggle-normal))

  (defun gb/next-window ()
    (interactive)
    (other-window 1)

  (defun gb/toggle-normal (&optional arg)
    (evil-normal-state))

  (defun gb/other-window ()
    (interactive)
    (ace-select-window)
    (gb/toggle-normal))

  (defun gb/prev-window ()
    (interactive)
    (other-window -1)
    (gb/toggle-normal))

  (defun gb/next-window ()
    (interactive)
    (other-window 1)
    (gb/toggle-normal))

  (global-set-key (kbd "s-]") #'gb/next-window)
  (global-set-key (kbd "s-[") #'gb/prev-window)
  (global-set-key (kbd "C-x o") #'gb/other-window)(gb/toggle-normal))

  (global-set-key (kbd "C-x o") #'gb/other-window)

  (global-set-key (kbd "C-x 2") 'gb/split-window-below-and-switch)
  (global-set-key (kbd "C-x 3") 'gb/split-window-right-and-switch)
  (global-set-key (kbd "C-x k") 'gb/kill-current-buffer)
  (global-set-key (kbd "C-x C-b") 'ibuffer)
  (global-set-key (kbd "C-c g") 'gb/generate-scratch-buffer)
#+end_src
** UI Config




#+begin_src emacs-lisp
  (setq-default indent-tabs-mode nil)
  (setq vc-follow-symlinks t)
  (setq-default tab-width 2)
  (tool-bar-mode 0)
  (menu-bar-mode 0)
  (scroll-bar-mode -1)
  (setq inhibit-startup-message t)
  (setq ring-bell-function 'ignore)
  (setq scroll-conservatively 100)
  (progn (global-hl-line-mode)
      (set-face-background 'hl-line "#2e3544"))
  (global-display-line-numbers-mode t)

  (dolist (mode '(org-mode-hook
              term-mode-hook
              shell-mode-hook
              treemacs-mode-hook
              eshell-mode-hook))
  (add-hook mode (lambda () (display-line-numbers-mode 0))))

  (setq default-font "JetBrainsMono Nerd Font Mono")
  (setq default-font-size 7)
  (setq current-font-size default-font-size)

  (setq font-change-increment 1.1)

  (defun font-code ()
  (concat default-font "-" (number-to-string current-font-size)))

  (defun gb/set-font-size ()
    "Set the font to `default-font' at `current-font-size'.
  Set that for the current frame, and also make it the default for
  other, future frames."
    (let ((font-code (font-code)))
      (add-to-list 'default-frame-alist (cons 'font font-code))
      (set-frame-font font-code)))

  (defun gb/reset-font-size ()
    "Change font size back to `default-font-size'."
    (interactive)
    (setq current-font-size default-font-size)
    (gb/set-font-size))

  (defun gb/increase-font-size ()
    "Gb/Increase current font size by a factor of `font-change-increment'."
    (interactive)
    (setq current-font-size
          (ceiling (* current-font-size font-change-increment)))
    (gb/set-font-size))

  (defun gb/decrease-font-size ()
    "gb/decrease current font size by a factor of `font-change-increment', down to a minimum size of 1."
    (interactive)
    (setq current-font-size
          (max 1
               (floor (/ current-font-size font-change-increment))))
    (gb/set-font-size))

  (use-package transpose-frame :ensure t
    :bind ("C-t" . transpose-frame))



  (define-key global-map (kbd "C-)") 'gb/reset-font-size)
  (define-key global-map (kbd "C-+") 'gb/increase-font-size)
  (define-key global-map (kbd "C-=") 'gb/increase-font-size)
  (define-key global-map (kbd "C-_") 'gb/decrease-font-size)
  (define-key global-map (kbd "C--") 'gb/decrease-font-size)

  (gb/reset-font-size)
#+end_src
** no-littering
#+begin_src emacs-lisp
  (use-package no-littering)
  (setq auto-save-file-name-transforms
        `((".*" ,(no-littering-expand-var-file-name "auto-save/") t)))

  ;; Change the user-emacs-directory to keep unwanted things out of ~/.emacs.d
  (setq user-emacs-directory (expand-file-name "~/.cache/emacs/")
        url-history-file (expand-file-name "url/history" user-emacs-directory))

  ;; Keep customization settings in a temporary file (thanks Ambrevar!)
  (setq custom-file
        (if (boundp 'server-socket-dir)
            (expand-file-name "custom.el" server-socket-dir)
          (expand-file-name (format "emacs-custom-%s.el" (user-uid)) temporary-file-directory)))
  (load custom-file t)
#+end_src
* Evil Mode
#+BEGIN_SRC emacs-lisp
  (setq evil-want-keybinding nil)
  (use-package evil
    :init
    (setq evil-want-abbrev-expand-on-insert-exit nil)
          ;; evil-want-keybinding nil)
    (setq evil-want-integration t)
    (setq evil-want-keybinding nil)
    (setq evil-want-C-u-scroll t)
    (setq evil-want-C-i-jump nil)
    :config
    (add-hook 'after-save-hook #'evil-normal-state)
    (evil-mode 1)
    (define-key evil-insert-state-map (kbd "C-g") 'evil-normal-state)
    (define-key evil-insert-state-map (kbd "C-h") 'evil-delete-backward-char-and-join)
    ;; Use visual line motions even outside of visual-line-mode buffers
    (evil-global-set-key 'motion "j" 'evil-next-visual-line)
    (evil-global-set-key 'motion "k" 'evil-previous-visual-line)
    (evil-set-initial-state 'messages-buffer-mode 'normal)
    (evil-set-initial-state 'dashboard-mode 'normal))

  (use-package evil-collection
    :after evil
    :config
    (evil-collection-init))

  (use-package evil-surround
    :config
    (global-evil-surround-mode 1))

  (use-package evil-org
    :after org
    :config
    (add-hook 'org-mode-hook 'evil-org-mode)
    (add-hook 'evil-org-mode-hook
              (lambda () (evil-org-set-key-theme)))
    (require 'evil-org-agenda)
    (evil-org-agenda-set-keys))

  (use-package evil-nerd-commenter
    :bind ("M-;" . evilnc-comment-or-uncomment-lines))

  (use-package origami :ensure t
    :hook (prog-mode . origami-mode))

  (use-package undo-tree :ensure t
    :config
    (evil-set-undo-system 'undo-tree)
    (global-undo-tree-mode)
    (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo"))))

  (use-package evil-smartparens :ensure t
    :config
    (smartparens-global-mode))

  (defun indent-between-pair (&rest _ignored)
    (newline)
    (indent-according-to-mode)
    (forward-line -1)
    (indent-according-to-mode))

  (sp-local-pair 'prog-mode "{" nil :post-handlers '((indent-between-pair "RET")))
  (sp-local-pair 'prog-mode "[" nil :post-handlers '((indent-between-pair "RET")))
  (sp-local-pair 'prog-mode "(" nil :post-handlers '((indent-between-pair "RET")))


  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)
#+END_SRC
* General.el Leader Key
#+begin_src emacs-lisp
  (use-package general :ensure t
    :after evil-smartparens
    :config
    (general-create-definer gb/leader-keys
      :keymaps '(normal insert visual emacs)
      :prefix "SPC"
      :global-prefix "C-SPC")

    (gb/leader-keys
      "c"  '(:ignore t :which-key "compilation")
      "cc" '(compile :which-key "compile project")
      "cf" '(flymake-show-buffer-diagnostics :which-key "buffer diagnostics")
      "e"  '(:ignore t :which-key "emacs commands")
      "ei" '(package-install :which-key "package-install")
      "el" '(list-packages :which-key "list-packages")
      "eu" '(gb/package-upgrade-all :which-key "upgrade all packages")
      "ec" '(projectile-invalidate-cache :which-key "invalidate projectile cache")
      "ev" '(set-variable :which-key "set variable")
      "et" '(transpose-frame :wk "transpose frame")
      "t"  '(:ignore t :which-key "toggles")
      "s"  '(:ignore t :which-key "smartparens")
      "s<" '(sp-backward-barf-sexp :wk "Barf backward")
      "s>" '(sp-forward-barf-sexp :wk "Barf forward")
      "s(" '(sp-backward-slurp-sexp :wk "Slurp backward")
      "s)" '(sp-forward-slurp-sexp :wk "Slurp forward")
      "s}" '(sp-slurp-hybrid-sexp :wk "Slurp (hybrid)")
      "s+" '(sp-join-sexp :wk "Join")
      "s-" '(sp-split-sexp :wk "Split")
      "sa" '(sp-absorb-sexp :wk "Absorb")
      "sc" '(sp-clone-sexp :wk "Clone")
      "sC" '(sp-convolute-sexp :wk "Convolute")
      "sm" '(sp-mark-sexp :wk "Mark")
      "sr" '(sp-raise-sexp :wk "Raise")
      "ss" '(sp-splice-sexp-killing-around :wk "Splice")
      "st" '(sp-transpose-sexp :wk "Transpose")
      "sT" '(sp-transpose-hybrid-sexp :wk "Transpose (hybrid)")
      ;; Narrow and Widen, use default emacs for widening
      "sn" '(sp-narrow-to-sexp :wk "Narrow"))
    )
#+end_src
* Add Hydra keymap
#+begin_src emacs-lisp
  (use-package hydra)

  (defhydra hydra-text-scale (:timeout 4)
    "scale text"
    ("j" text-scale-increase "in")
    ("k" text-scale-decrease "out")
    ("f" nil "finished" :exit t))

  (gb/leader-keys
    "ts" '(hydra-text-scale/body :which-key "scale text"))
#+end_src
* Add projectile.el
#+begin_src emacs-lisp
  (use-package projectile
    :diminish projectile-mode
    :config (projectile-mode)
    :bind-keymap
    ("C-c p" . projectile-command-map)
    :init
    (setq projectile-switch-project-action #'projectile-dired)
    :config
    (setq projectile-enable-caching t)
    (projectile-global-mode))

#+end_src
* Magit
  #+begin_src emacs-lisp
    (use-package magit
      ;; :custom
      ;; (magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1)
      :bind ("C-x g" . magit-status))
  #+end_src
* lsp mode
#+begin_src emacs-lisp
  (defun lsp-booster--advice-json-parse (old-fn &rest args)
    "Try to parse bytecode instead of json."
    (or
     (when (equal (following-char) ?#)
       (let ((bytecode (read (current-buffer))))
         (when (byte-code-function-p bytecode)
           (funcall bytecode))))
     (apply old-fn args)))
  (advice-add (if (progn (require 'json)
                         (fboundp 'json-parse-buffer))
                  'json-parse-buffer
                'json-read)
              :around
              #'lsp-booster--advice-json-parse)

  (defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
    "Prepend emacs-lsp-booster command to lsp CMD."
    (let ((orig-result (funcall old-fn cmd test?)))
      (if (and (not test?)                             ;; for check lsp-server-present?
               (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
               lsp-use-plists
               (not (functionp 'json-rpc-connection))  ;; native json-rpc
               (executable-find "emacs-lsp-booster"))
          (progn
            (message "Using emacs-lsp-booster for %s!" orig-result)
            (cons "emacs-lsp-booster" orig-result))
        orig-result)))

  (advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command)

  (defun gb/lsp-mode-setup ()
    (setq lsp-headerline-breadcrumb-segments '(path-up-to-project file symbols))
    (lsp-headerline-breadcrumb-mode))

  (use-package lsp-mode
    :commands (lsp lsp-deferred)
    :hook (lsp-mode . gb/lsp-mode-setup)
    :init
    (setq lsp-keymap-prefix "C-c l")  ;; Or 'C-l', 's-l'
    :config
    (lsp-enable-which-key-integration t)
    (add-hook 'lsp-mode-hook #'lsp-headerline-breadcrumb-mode)
    (setq lsp-headerline-breadcrumb-enable t)
    (setq lsp-clients-clangd-args '(
                                    ;; If set to true, code completion will include index symbols that are not defined in the scopes
                                    ;; (e.g. namespaces) visible from the code completion point. Such completions can insert scope qualifiers
                                    "--all-scopes-completion"
                                    ;; Index project code in the background and persist index on disk.
                                    "--background-index"
                                    ;; Enable clang-tidy diagnostics
                                    "--clang-tidy"
                                    ;; Whether the clang-parser is used for code-completion
                                    ;;   Use text-based completion if the parser is not ready (auto)
                                    "--completion-parse=auto"
                                    ;; Granularity of code completion suggestions
                                    ;;   One completion item for each semantically distinct completion, with full type information (detailed)
                                    "--completion-style=detailed"
                                    ;; clang-format style to apply by default when no .clang-format file is found
                                    "--fallback-style=Chromium"
                                    ;; When disabled, completions contain only parentheses for function calls.
                                    ;; When enabled, completions also contain placeholders for method parameters
                                    "--function-arg-placeholders"
                                    ;; Add #include directives when accepting code completions
                                    ;;   Include what you use. Insert the owning header for top-level symbols, unless the
                                    ;;   header is already directly included or the symbol is forward-declared
                                    "--header-insertion=iwyu"
                                    ;; Prepend a circular dot or space before the completion label, depending on whether an include line will be inserted or not
                                    "--header-insertion-decorators"
                                    ;; Enable index-based features. By default, clangd maintains an index built from symbols in opened files.
                                    ;; Global index support needs to enabled separatedly
                                    "--index"
                                    ;; Attempts to fix diagnostic errors caused by missing includes using index
                                    "--suggest-missing-includes"
                                    ;; Number of async workers used by clangd. Background index also uses this many workers.
                                    "-j=4"
                                    ))
    )

   ;; (use-package ccls
   ;;   :hook ((c-mode c++-mode objc-mode cuda-mode) .
   ;;          (lambda () (require 'ccls) (lsp))))

  (use-package google-c-style
    :hook ((c-mode c++-mode) . google-set-c-style))

  (gb/leader-keys
    "tl" '(lsp-headerline-breadcrumb-mode :which-key "toggle lsp-headerline")
    "cf" '(lsp-format-buffer :which-key "lsp-format buffer")
    "cl" '(xref-find-definitions :which-key "lsp find definition")
    "ck" '(lsp-find-references :which-key "lsp find references")
    "cr" '(lsp-rename :wk "rename symbol")
    "c;" '(lsp-ui-peek-find-references :which-key "lsp peek references"))

  (use-package lsp-ui
    :after lsp-mode
    :custom
    (lsp-ui-doc-show-with-cursor t)
    (lsp-ui-doc-show-with-mouse t)
    (lsp-ui-doc-position 'at-point)
    (lsp-ui-sideline-delay 0.5)
    (lsp-ui-peek-always-show t)
    (lsp-ui-peek-fontify 'always)
    ;; :custom-face
    ;; (lsp-ui-peek-highlight ((t (:inherit nil :background nil :foreground nil :weight semi-bold :box (:line-width -1)))))
    :bind
    ( :map lsp-ui-mode-map
      ([remap xref-find-references] . lsp-ui-peek-find-references)
      ("C-M-l" . lsp-ui-peek-find-definitions)
      ("C-c C-d" . lsp-ui-doc-show))
    :config
      ;;;; LSP UI posframe ;;;;
    (defun lsp-ui-peek--peek-display (src1 src2)
      (-let* ((win-width (frame-width))
              (lsp-ui-peek-list-width (/ (frame-width) 2))
              (string (-some--> (-zip-fill "" src1 src2)
                        (--map (lsp-ui-peek--adjust win-width it) it)
                        (-map-indexed 'lsp-ui-peek--make-line it)
                        (-concat it (lsp-ui-peek--make-footer))))
              )
        (setq lsp-ui-peek--buffer (get-buffer-create " *lsp-peek--buffer*"))
        (posframe-show lsp-ui-peek--buffer
                       :string (mapconcat 'identity string "")
                       :min-width (frame-width)
                       :poshandler 'posframe-poshandler-frame-center)))

    (defun lsp-ui-peek--peek-destroy ()
      (when (bufferp lsp-ui-peek--buffer)
        (posframe-delete lsp-ui-peek--buffer))
      (setq lsp-ui-peek--buffer nil
            lsp-ui-peek--last-xref nil)
      (set-window-start (get-buffer-window) lsp-ui-peek--win-start))

    (advice-add 'lsp-ui-peek--peek-new :override 'lsp-ui-peek--peek-display)
    (advice-add 'lsp-ui-peek--peek-hide :override 'lsp-ui-peek--peek-destroy)
      ;;;; LSP UI posframe ;;;;
    )

  (use-package lsp-pyright
    :ensure t
    ;; :hook (python-ts-mode . (lambda ()
    ;;                           (require 'lsp-pyright)
    ;;                           (lsp)))
    :hook (python-mode . (lambda ()
                              (require 'lsp-pyright)
                              (lsp)))
  )

  (use-package lsp-ui
    :hook (lsp-mode . lsp-ui-mode)
    :custom
    (lsp-ui-doc-position 'bottom))

  (use-package treemacs)

  (use-package lsp-treemacs
    :after (lsp treemacs))

#+end_src
* company mode
#+begin_src emacs-lisp
  (use-package company
    :after lsp-mode
    :hook (lsp-mode . company-mode)
    :hook (js2-mode-hook . company-mode)
    :bind (:map company-active-map
           ("<tab>" . company-complete-selection))
          (:map lsp-mode-map
           ("<tab>" . company-indent-or-complete-common))
    :custom
    (company-minimum-prefix-length 1)
    (company-idle-delay 0.3))

  (use-package company-box
    :after (company)
    :hook (company-mode . company-box-mode))

  (use-package company-c-headers
    :after (company)
    :config
      (add-to-list 'company-backends 'company-c-headers)
      (add-to-list 'company-c-headers-path-system "/usr/local/include/"))

  (use-package company-dabbrev
    :ensure nil
    :after (company)
    :config (progn
      (setq company-dabbrev-ignore-case t)
      (setq company-dabbrev-downcase nil)))
      (add-hook 'after-init-hook 'global-company-mode)

#+end_src
* avy nav
#+begin_src emacs-lisp
  (use-package avy
    :config
    (global-set-key (kbd "C-x f") 'avy-goto-char-timer))


  (defun gb/pop-local-mark-ring ()
    (interactive)
    (set-mark-command t))

  (defun gb/unpop-to-mark-command ()
    "Unpop off mark ring. Does nothing if mark ring is empty."
    (interactive)
        (when mark-ring
          (setq mark-ring (cons (copy-marker (mark-marker)) mark-ring))
          (set-marker (mark-marker) (car (last mark-ring)) (current-buffer))
          (when (null (mark t)) (ding))
          (setq mark-ring (nbutlast mark-ring))
          (goto-char (marker-position (car (last mark-ring))))))

  (global-set-key (kbd "M-[") 'gb/pop-local-mark-ring)
  (global-set-key (kbd "M-]") 'gb/unpop-to-mark-command)

  (global-set-key (kbd "s-<") 'previous-buffer)
  (global-set-key (kbd "s->") 'next-buffer)
#+end_src
* eshell config
#+begin_src emacs-lisp
  (use-package term
    :ensure t
    :config
    (setq explicit-shell-file-name "zsh") ;; Change this to zsh, etc
    ;;(setq explicit-zsh-args '())         ;; Use 'explicit-<shell>-args for shell-specific args

    ;; Match the default Bash shell prompt.  Update this if you have a custom prompt
    (setq term-prompt-regexp "^[^#$%>\n]*[#$%>] *"))

  (use-package eterm-256color
    :hook (term-mode . eterm-256color-mode))

  (use-package vterm
    :commands vterm
    :config
    ;; (setq term-prompt-regexp "^[^#$%>\n]*[#$%>] *")  ;; Set this to match your custom shell prompt
    (setq vterm-shell "zsh")                       ;; Set this to customize the shell to launch
    (setq vterm-max-scrollback 10000))

  (defun b/configure-term ()
    "Change face, and disable line numbers for terminals. FiraCode causes alignment issues :("
    (interactive)
    (setenv "TERM" "xterm-256color")
    (global-hl-line-mode 0)
    (setq buffer-face-mode-face '(:height 140 :family "MesloLGS Nerd Font"))
    (buffer-face-mode))


  (gb/leader-keys
    "ct" '(vterm :which-key "open vterm"))
    "cr" '(b/configure-term :which-key "open vterm")

  (when (eq system-type 'windows-nt)
    (setq explicit-shell-file-name "powershell.exe")
    (setq explicit-powershell.exe-args '()))

  (defun gb/configure-eshell ()
    ;; Save command history when commands are entered
    (add-hook 'eshell-pre-command-hook 'eshell-save-some-history)

    ;; Truncate buffer for performance
    (add-to-list 'eshell-output-filter-functions 'eshell-truncate-buffer)

    ;; Bind some useful keys for evil-mode
    ;; (evil-define-key '(normal insert visual) eshell-mode-map (kbd "C-r") 'counsel-esh-history)
    (evil-define-key '(normal insert visual) eshell-mode-map (kbd "<home>") 'eshell-bol)
    (evil-normalize-keymaps)

    (setq eshell-history-size         10000
          eshell-buffer-maximum-lines 10000
          eshell-hist-ignoredups t
          eshell-scroll-to-bottom-on-input t))

  (use-package eshell-git-prompt)

  (use-package eshell
    :hook (eshell-first-time-mode . gb/configure-eshell)
    :config

    (with-eval-after-load 'esh-opt
      (setq eshell-destroy-buffer-when-process-dies t)
      (setq eshell-visual-commands '("htop" "zsh" "vim")))

    (eshell-git-prompt-use-theme 'powerline))
#+end_src
* Dired
#+begin_src emacs-lisp
  (use-package dired
    :ensure nil
    :commands (dired dired-jump)
    :bind (("C-x C-j" . dired-jump))
    :custom ((dired-listing-switches "-agho --group-directories-first"))
    :config
    (when (string= system-type "darwin")
      (setq dired-use-ls-dired t
            insert-directory-program "gls"))
    (setq dired-clean-up-buffers-too t)
    (setq dired-recursive-copies 'always)
    (setq dired-recursive-deletes 'top)
    ;; (setq insert-directory-program "gls" dired-use-ls-dired t)
    (setq dired-listing-switches "-al --group-directories-first")
    (evil-collection-define-key 'normal 'dired-mode-map
      "h" 'dired-single-up-directory
      "l" 'dired-single-buffer))

  (use-package dired-single)

  (use-package all-the-icons-dired
    :hook (dired-mode . all-the-icons-dired-mode))

  (use-package dired-open
    :config
    ;; Doesn't work as expected!
    ;;(add-to-list 'dired-open-functions #'dired-open-xdg t)
    (setq dired-open-extensions '(("png" . "feh")
                                  ("mkv" . "mpv"))))

  (use-package dired-hide-dotfiles
    :hook (dired-mode . dired-hide-dotfiles-mode)
    :config
    (evil-collection-define-key 'normal 'dired-mode-map
      "H" 'dired-hide-dotfiles-mode))
#+end_src
* Backup management
#+begin_src emacs-lisp
  (setq version-control t     ;; Use version numbers for backups.
      kept-new-versions 10  ;; Number of newest versions to keep.
      kept-old-versions 0   ;; Number of oldest versions to keep.
      delete-old-versions t ;; Don't ask to delete excess backup versions.
      backup-by-copying t)  ;; Copy all files, don't rename them.
  (setq vc-make-backup-files t)
  ;; Default and per-save backups go here:
  (setq backup-directory-alist '(("" . "~/.emacs.d/backup/per-save")))

  (defun force-backup-of-buffer ()
  ;; Make a special "per session" backup at the first save of each
  ;; emacs session.
  (when (not buffer-backed-up)
      ;; Override the default parameters for per-session backups.
      (let ((backup-directory-alist '(("" . "~/.emacs.d/backup/per-session")))
          (kept-new-versions 3))
      (backup-buffer)))
  ;; Make a "per save" backup on each save.  The first save results in
  ;; both a per-session and a per-save backup, to keep the numbering
  ;; of per-save backups consistent.
  (let ((buffer-backed-up nil))
      (backup-buffer)))

  (add-hook 'before-save-hook  'force-backup-of-buffer)
#+end_src
* Utility functions
#+begin_src emacs-lisp
  (defun gb/duplicate-line-or-region (&optional n)
    "Gb/Duplicate current line, or region if active"
    (interactive "*p")
    (let ((use-region (use-region-p)))
      (save-excursion
        (let ((text (if use-region
                        (buffer-substring (region-beginning) (region-end))
                      (prog1 (thing-at-point 'line)
                        (end-of-line)
                        (if (< 0 (forward-line 1))
                            (newline))))))
          (dotimes (i (abs (or n 1)))
            (insert text))))
      (if use-region nil
        (let ((pos (- (point) (line-beginning-position) (line-end-position)))
              (forward-line 1)
              (forward-char pos))))))

  (defun gb/open-init-file ()
    "Open the init file."
    (interactive)
    (find-file "~/.emacs.d/literate_init.org"))

  (gb/leader-keys
    "cd" '(gb/duplicate-line-or-region :which-key "duplicate line or region")
    "ee" '(gb/open-init-file :which-key "open init file"))

  (global-set-key (kbd "C-c C-d") 'gb/duplicate-line-or-region)
#+end_src

* Tramp config
#+begin_src emacs-lisp
  (use-package tramp
    :ensure nil
    :config
    (setq tramp-terminal-type "dumb")
    (setq tramp-inline-compress-start-size 10000000)
    (setq tramp-debug-buffer t)
    (setq tramp-verbose 10))
#+end_src
* Development & Major Modes
** dap-mode
#+begin_src emacs-lisp
  (use-package dap-mode
    ;; Uncomment the config below if you want all UI panes to be hidden by default!
    :custom
    (lsp-enable-dap-auto-configure nil)
    :config
    (dap-ui-mode 1)

    :config
    ;; Bind `C-c l d` to `dap-hydra` for easy access
    (general-define-key
     :keymaps 'lsp-mode-map
     :prefix lsp-keymap-prefix
     "d" '(dap-hydra t :wk "debugger")))

  ;; (use-package dap-cpptools
  ;;   :after dap-mode
  ;;   :config
  ;;   (dap-cpptools-setup))

  ;; (use-package dap-node
  ;;   :after dap-mode
  ;;   :config
  ;;   (dap-node-setup))
#+end_src
* ace-window
#+begin_src emacs-lisp
  (use-package ace-window
    :ensure t
    :init
    (progn
      (global-set-key [remap other-window] 'ace-window)
      (custom-set-faces
       '(aw-leading-char-face
         ((t (:inherit ace-jump-face-foreground :height 3.0)))))
      ))
#+end_src
* git-link
#+begin_src emacs-lisp
  (use-package git-link :ensure t
    :config
    (setq git-link-open-in-browser nil
          git-link-use-commit t))

  (gb/leader-keys
    "cg" '(git-link :which-key "git link to clipboard"))
#+end_src
** org mode
#+begin_src emacs-lisp
  ;; This is needed as of Org 9.2
  (require 'org-tempo)

  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python"))
#+end_src
** yasnippets
   #+begin_src emacs-lisp
     ;; (add-to-list 'load-path
     ;;               "~/.emacs.d/plugins/yasnippet")
     ;; (require 'yasnippet)
     ;; (yas-global-mode 1)
   #+end_src
* languages
** typescript / javascript
#+begin_src emacs-lisp
    (use-package flymake-eslint :ensure t :defer 10
      :custom ;; add glasses-mode to bolden capitals in CamelCase here. Could also be done elsewhere.
      (glasses-face (quote bold))
      (glasses-original-separator "")
      (glasses-separate-capital-groups t)
      (glasses-separate-parentheses-p nil)
      (glasses-separator "")
      :config
      (add-hook 'js-mode-hook (lambda () (flymake-eslint-enable)(flymake-mode -1)(flycheck-mode 1)(glasses-mode 1)))
      (add-hook 'js2-mode-hook (lambda () (flymake-eslint-enable)(flymake-mode -1)(flycheck-mode 1)(glasses-mode 1)))
      (custom-set-variables
       '(help-at-pt-timer-delay 0.3)
       '(help-at-pt-display-when-idle '(flymake-overlay))))

    (use-package web-mode :ensure t)

    (use-package typescript-mode :ensure t
      :config
      (add-to-list 'auto-mode-alist '("\\.tsx\\'" . typescript-mode))
      (add-to-list 'auto-mode-alist '("\\.svelte\\'" . typescript-mode))
      (setq-default typescript-ident-level 2))

    (use-package tide :ensure t
      :after (typescript-mode company flycheck)
      :hook ((typescript-mode . tide-setup)
             (typescript-mode . tide-hl-identifier-mode)
             ;; (before-save . tide-format-before-save)
             )
      :config
      (flycheck-add-next-checker 'typescript-tide 'javascript-eslint))

    (use-package add-node-modules-path
      :ensure t
      :hook ((typescript-mode . add-node-modules-path)))
#+end_src
** golang
#+begin_src emacs-lisp
  (defun lsp-go-install-save-hooks ()
    (add-hook 'before-save-hook #'lsp-format-buffer t t)
    (add-hook 'before-save-hook #'lsp-organize-imports t t))

  (use-package go-ts-mode
    :after lsp-mode
    :defer t
    :hook
    (go-ts-mode . lsp-deferred)
    (go-ts-mode . lsp-go-install-save-hooks)
    :init
    (add-to-list 'auto-mode-alist '("\\.go\\'" . go-ts-mode))
    (add-to-list 'auto-mode-alist '("/go\\.mod\\'" . go-mod-ts-mode))
    :custom
    (go-ts-mode-indent-offset 2)
    :config
    (reformatter-define go-format
      :program "goimports"
      :args '("/dev/stdin"))
    (setq lsp-go-codelenses '(
                              (test . t)
                              (tidy . t)
                              (vendor . t)
                              (run_govulncheck . t))
          lsp-go-analyses '(
                            (nilness . t)
                            (shadow . t)
                            (unusedwrite . t)
                            (fieldalignment . t)
                            )
          )
    )

  (use-package go-tag :ensure t)

  (use-package godoctor :ensure t)

  (defhydra go-refactor (:timeout 4)
    "go refactor"
    ("ta" go-tag-add "add tag")
    ("tr" go-tag-remove "remove tag")
    ("fr" godoctor-extract "extract body")
    ("fd" godoctor-godoc "make docstring")
    )

  (gb/leader-keys
    "g" '(go-refactor/body :which-key "go refactor commands"))

  (require 'dap-dlv-go)

#+end_src
** c++/c
#+begin_src emacs-lisp
    (add-hook 'c++-ts-mode-hook (lambda ()
                               (push '(?< . ("< " . " >")) evil-surround-pairs-alist)))
    (defun my-c-mode-common-hook ()
      ;; my customizations for all of c-mode, c++-mode, objc-mode, java-mode
      (c-set-offset 'substatement-open 0)
      ;; other customizations can go here

      (setq c++-tab-always-indent t)
      (setq c-basic-offset 2)                  ;; Default is 2
      (setq c-indent-level 2)                  ;; Default is 2
      (c-set-offset 'access-label -4)
      (c-set-offset 'inclass 0)
      (setq tab-stop-list '(2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40))
      (setq tab-width 2)
      (setq indent-tabs-mode t)  ; use spaces only if nil
      )

    (add-hook 'c-mode-common-hook 'my-c-mode-common-hook)
    (add-hook 'c-ts-mode-hook 'lsp)
    (add-hook 'c++-ts-mode-hook 'lsp)

    (use-package modern-cpp-font-lock :ensure t
      :hook (c++-ts-mode-hook . 'modern-c++-font-lock-mode))
    (use-package cpp-auto-include :ensure t)
#+end_src
** python
#+begin_src emacs-lisp
  (use-package python-mode
    :ensure t
    :hook (python-mode . lsp-deferred)
    :custom
    ;; NOTE: Set these if Python 3 is called "python3" on your system!
    (python-shell-interpreter "python3")
    (dap-python-executable "python3")
    (dap-python-debugger 'debugpy)
    :config
    (require 'dap-python))

  (use-package python-black
    :demand t
    :after python)

  (gb/leader-keys
    "cp" '(python-black-buffer :which-key "run black on buffer"))
#+end_src
** json
#+begin_src emacs-lisp
  (use-package json-mode :ensure t :defer 20
    :custom
    (json-reformat:indent-width 2)
    :mode (("\\.bowerrc$"     . json-mode)
           ("\\.jshintrc$"    . json-mode)
           ("\\.json_schema$" . json-mode)
           ("\\.json\\'" . json-mode))
    :bind (:package json-mode-map
           :map json-mode-map
           ("C-c <tab>" . json-mode-beautify)))
#+end_src
** docker
#+begin_src emacs-lisp

#+end_src
** treesitter
#+begin_src emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name
          "straight/repos/straight.el/bootstrap.el"
          (or (bound-and-true-p straight-base-dir)
              user-emacs-directory)))
        (bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  (use-package tree-sitter
    :config
    ;; activate tree-sitter on any buffer containing code for which it has a parser available
    (global-tree-sitter-mode)
    ;; you can easily see the difference tree-sitter-hl-mode makes for python, ts or tsx
    ;; by switching on and off
    (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode))

  (use-package tree-sitter-langs
    :ensure t
    :after tree-sitter)

  ;; (use-package treesit-auto
  ;;   :after (lsp-mode)
  ;;   :ensure t
  ;;   :demand t
  ;;   :config
  ;;   (global-treesit-auto-mode))

  ;; (setq treesit-language-source-alist
  ;;   '((bash "https://github.com/tree-sitter/tree-sitter-bash")
  ;;     (c "https://github.com/tree-sitter/tree-sitter-c")
  ;;     (cmake "https://github.com/uyha/tree-sitter-cmake")
  ;;     (common-lisp "https://github.com/theHamsta/tree-sitter-commonlisp")
  ;;     (cpp "https://github.com/tree-sitter/tree-sitter-cpp")
  ;;     (css "https://github.com/tree-sitter/tree-sitter-css")
  ;;     (csharp "https://github.com/tree-sitter/tree-sitter-c-sharp")
  ;;     (elisp "https://github.com/Wilfred/tree-sitter-elisp")
  ;;     (go "https://github.com/tree-sitter/tree-sitter-go")
  ;;     (go-mod "https://github.com/camdencheek/tree-sitter-go-mod")
  ;;     (html "https://github.com/tree-sitter/tree-sitter-html")
  ;;     (js . ("https://github.com/tree-sitter/tree-sitter-javascript" "master" "src"))
  ;;     (json "https://github.com/tree-sitter/tree-sitter-json")
  ;;     (lua "https://github.com/Azganoth/tree-sitter-lua")
  ;;     (make "https://github.com/alemuller/tree-sitter-make")
  ;;     (markdown "https://github.com/ikatyang/tree-sitter-markdown")
  ;;     (python "https://github.com/tree-sitter/tree-sitter-python")
  ;;     (r "https://github.com/r-lib/tree-sitter-r")
  ;;     (rust "https://github.com/tree-sitter/tree-sitter-rust")
  ;;     (toml "https://github.com/tree-sitter/tree-sitter-toml")
  ;;     (tsx . ("https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src"))
  ;;     (typescript . ("https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src"))
  ;;     (yaml "https://github.com/ikatyang/tree-sitter-yaml")))

  (use-package treesit-parser-manager
    :straight (treesit-parser-manager :host codeberg :repo "ckruse/treesit-parser-manager" :files ("*.el"))
    :commands (treesit-parser-manager-install-grammars
               treesit-parser-manager-update-grammars
               treesit-parser-manager-install-or-update-grammars
               treesit-parser-manager-remove-grammar)
    :custom
    (setq treesit-parser-manager-grammars
        '(
          ("https://github.com/tree-sitter/tree-sitter-bash"
           ("tree-sitter-bash"))

          ("https://github.com/tree-sitter/tree-sitter-c"
           ("tree-sitter-c"))

          ("https://github.com/uyha/tree-sitter-cmake"
           ("tree-sitter-cmake"))

          ("https://github.com/theHamsta/tree-sitter-commonlisp"
           ("tree-sitter-commonlisp"))

          ("https://github.com/tree-sitter/tree-sitter-cpp"
           ("tree-sitter-cpp"))

          ("https://github.com/tree-sitter/tree-sitter-css"
           ("tree-sitter-css"))

          ("https://github.com/tree-sitter/tree-sitter-c-sharp"
           ("tree-sitter-c-sharp"))

          ("https://github.com/Wilfred/tree-sitter-elisp"
           ("tree-sitter-elisp"))

          ("https://github.com/tree-sitter/tree-sitter-go"
           ("tree-sitter-go"))

          ("https://github.com/camdencheek/tree-sitter-go-mod"
           ("tree-sitter-go-mod"))

          ("https://github.com/tree-sitter/tree-sitter-html"
           ("tree-sitter-html"))

          ("https://github.com/tree-sitter/tree-sitter-javascript"
           ("tree-sitter-javascript"))

          ("https://github.com/tree-sitter/tree-sitter-json"
           ("tree-sitter-json"))

          ("https://github.com/Azganoth/tree-sitter-lua"
           ("tree-sitter-lua"))

          ("https://github.com/alemuller/tree-sitter-make"
           ("tree-sitter-make"))

          ("https://github.com/ikatyang/tree-sitter-markdown"
           ("tree-sitter-markdown"))

          ("https://github.com/tree-sitter/tree-sitter-python"
           ("tree-sitter-python"))

          ("https://github.com/r-lib/tree-sitter-r"
           ("tree-sitter-r"))

          ("https://github.com/tree-sitter/tree-sitter-rust"
           ("tree-sitter-rust"))

          ("https://github.com/ikatyang/tree-sitter-toml"
           ("tree-sitter-toml"))

          ("https://github.com/tree-sitter/tree-sitter-typescript"
           ("tree-sitter-typescript/tsx" "tree-sitter-typescript/typescript"))

          ("https://github.com/ikatyang/tree-sitter-yaml"
           ("tree-sitter-yaml"))
         ))
    :config
    (setq treesit-extra-load-path (list (expand-file-name "tree-sit" user-emacs-directory)))
    :hook (emacs-startup . treesit-parser-manager-install-grammars))


#+end_src
